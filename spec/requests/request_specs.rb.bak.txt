# spec/requests/accounts_spec.rb
require 'rails_helper'

RSpec.describe 'Accounts API', type: :request do
  describe 'GET /api/v1/accounts' do
    it 'returns all accounts' do
      create_list(:account, 3)
      
      get '/api/v1/accounts'
      
      expect(response).to have_http_status(:success)
      json = JSON.parse(response.body)
      expect(json['accounts'].length).to eq(3)
    end

    it 'filters by account type' do
      create(:account, :asset)
      create(:account, :liability)
      
      get '/api/v1/accounts', params: { account_type: 'ASSET' }
      
      json = JSON.parse(response.body)
      expect(json['accounts'].all? { |a| a['account_type'] == 'ASSET' }).to be true
    end
  end

  describe 'POST /api/v1/accounts' do
    it 'creates a new account' do
      account_params = {
        account: {
          code: 'TEST-001',
          name: 'Test Account',
          account_type: 'ASSET',
          currency: 'KES'
        }
      }

      post '/api/v1/accounts', params: account_params

      expect(response).to have_http_status(:created)
      json = JSON.parse(response.body)
      expect(json['code']).to eq('TEST-001')
    end
  end

  describe 'GET /api/v1/accounts/:id/balance' do
    let(:account) { create(:account, current_balance: 5000.0000) }

    it 'returns account balance' do
      get "/api/v1/accounts/#{account.id}/balance"

      expect(response).to have_http_status(:success)
      json = JSON.parse(response.body)
      expect(json['balance'].to_f).to eq(5000.0000)
    end
  end
end

# spec/requests/transactions_spec.rb
require 'rails_helper'

RSpec.describe 'Transactions API', type: :request do
  let(:account1) { create(:account) }
  let(:account2) { create(:account) }

  describe 'POST /api/v1/transactions' do
    it 'creates a new transaction' do
      transaction_params = {
        idempotency_key: 'api-test-123',
        description: 'API test transaction',
        entries: [
          { account_id: account1.id, debit: 1000.0000 },
          { account_id: account2.id, credit: 1000.0000 }
        ]
      }

      post '/api/v1/transactions', params: transaction_params

      expect(response).to have_http_status(:created)
      json = JSON.parse(response.body)
      expect(json['idempotency_key']).to eq('api-test-123')
      expect(json['balanced']).to be true
    end

    it 'rejects unbalanced transaction' do
      transaction_params = {
        idempotency_key: 'unbalanced-123',
        description: 'Unbalanced transaction',
        entries: [
          { account_id: account1.id, debit: 1000.0000 },
          { account_id: account2.id, credit: 500.0000 }
        ]
      }

      post '/api/v1/transactions', params: transaction_params

      expect(response).to have_http_status(:unprocessable_entity)
    end
  end
end

# spec/requests/reports_spec.rb
require 'rails_helper'

RSpec.describe 'Reports API', type: :request do
  describe 'GET /api/v1/reports/trial_balance' do
    before do
      create(:account, :asset, current_balance: 10000.0000)
      create(:account, :liability, current_balance: -10000.0000)
    end

    it 'returns trial balance' do
      get '/api/v1/reports/trial_balance'

      expect(response).to have_http_status(:success)
      json = JSON.parse(response.body)
      expect(json['balanced']).to be true
      expect(json['total_debits']).to eq(json['total_credits'])
    end
  end

  describe 'GET /api/v1/reports/balance_sheet' do
    it 'returns balance sheet' do
      get '/api/v1/reports/balance_sheet'

      expect(response).to have_http_status(:success)
      json = JSON.parse(response.body)
      expect(json).to have_key('assets')
      expect(json).to have_key('liabilities')
      expect(json).to have_key('equity')
    end
  end
end
